<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Currency Risk Management System - Working</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        .navbar {
            background: rgba(31, 41, 55, 0.95) !important;
            backdrop-filter: blur(10px);
        }
        .rate-display {
            font-size: 2.5rem;
            font-weight: 800;
            color: #10b981;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            padding: 12px 24px;
        }
        .alert-success {
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            color: white;
        }
        .metric-card {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: none;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Currency Risk Management - Backdated LC Analysis</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text" id="lastUpdate">Ready</span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Current Rates Section -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Current USD/INR Rate</h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="rate-display" id="currentRate">Loading...</div>
                        <small class="text-muted" id="rateTimestamp">Fetching latest rate...</small>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="loadCurrentRates()">Refresh Rate</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>System Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="systemStatus">
                            <div class="d-flex justify-content-between">
                                <span>Health:</span>
                                <span id="healthStatus" class="text-warning">Checking...</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Version:</span>
                                <span id="versionInfo">-</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Data Source:</span>
                                <span id="dataSource">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- P&L Calculator Section -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Backdated LC P&L Calculator</h5>
                        <small class="text-muted">Analyze Letters of Credit using real historical USD/INR data</small>
                    </div>
                    <div class="card-body">
                        <form id="plForm">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="lcNumber" class="form-label">LC Number</label>
                                    <input type="text" class="form-control" id="lcNumber" value="DEMO-LC-001" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="lcAmount" class="form-label">LC Amount (USD)</label>
                                    <input type="number" class="form-control" id="lcAmount" value="500000" required>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="contractRate" class="form-label">Contract Rate (INR per USD)</label>
                                    <input type="number" class="form-control" id="contractRate" value="82.50" step="0.01" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="businessType" class="form-label">Business Type</label>
                                    <select class="form-control" id="businessType" required>
                                        <option value="import">Import</option>
                                        <option value="export">Export</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="issueDate" class="form-label">Issue Date</label>
                                    <input type="date" class="form-control" id="issueDate" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="maturityDate" class="form-label">Maturity Date</label>
                                    <input type="date" class="form-control" id="maturityDate" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary btn-lg w-100">Calculate Backdated P&L</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="row" id="resultsSection" style="display: none;">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Analysis Results</h5>
                    </div>
                    <div class="card-body" id="results">
                        <!-- Results will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Set default dates for backdated analysis
        const today = new Date();
        const issueDate = new Date(today);
        issueDate.setDate(today.getDate() - 90); // 90 days ago

        const maturityDate = new Date(today);
        maturityDate.setDate(today.getDate() - 30); // 30 days ago

        document.getElementById('issueDate').value = issueDate.toISOString().split('T')[0];
        document.getElementById('maturityDate').value = maturityDate.toISOString().split('T')[0];

        // Load data on page load
        window.addEventListener('load', function() {
            console.log('üöÄ Page loaded, initializing...');
            
            // Set default dates
            const today = new Date();
            const twoMonthsAgo = new Date(today.getTime() - (60 * 24 * 60 * 60 * 1000)); // 60 days ago
            const oneMonthAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000)); // 30 days ago
            
            const issueDateElement = document.getElementById('issueDate');
            const maturityDateElement = document.getElementById('maturityDate');
            
            if (issueDateElement) {
                issueDateElement.value = twoMonthsAgo.toISOString().split('T')[0];
            }
            if (maturityDateElement) {
                maturityDateElement.value = oneMonthAgo.toISOString().split('T')[0];
            }
            
            checkHealth();
            loadCurrentRates();
        });

        async function checkHealth() {
            try {
                console.log('üîç Checking system health...');
                const response = await fetch('/api/health');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üè• Health data:', data);
                
                const healthElement = document.getElementById('healthStatus');
                const versionElement = document.getElementById('versionInfo');
                const dataSourceElement = document.getElementById('dataSource');
                
                if (data.status === 'healthy') {
                    if (healthElement) {
                        healthElement.textContent = '‚úÖ Online';
                        healthElement.className = 'text-success';
                    }
                    if (versionElement) versionElement.textContent = data.version || 'Unknown';
                    if (dataSourceElement) dataSourceElement.textContent = data.data_source || 'Unknown';
                } else {
                    if (healthElement) {
                        healthElement.textContent = '‚ùå Issues';
                        healthElement.className = 'text-danger';
                    }
                }
            } catch (error) {
                console.error('‚ùå Health check failed:', error);
                const healthElement = document.getElementById('healthStatus');
                if (healthElement) {
                    healthElement.textContent = '‚ùå Offline';
                    healthElement.className = 'text-danger';
                }
            }
        }

        async function loadCurrentRates() {
            try {
                console.log('üîç Loading current rates...');
                const currentRateElement = document.getElementById('currentRate');
                const timestampElement = document.getElementById('rateTimestamp');
                
                if (!currentRateElement || !timestampElement) {
                    console.error('‚ùå Required elements not found');
                    return;
                }
                
                currentRateElement.textContent = 'Loading...';
                timestampElement.textContent = 'Fetching latest rate...';
                
                const response = await fetch('/api/current-rates');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üìä Current rates data:', data);
                
                if (data.usd_inr && data.usd_inr > 0) {
                    currentRateElement.textContent = `‚Çπ${data.usd_inr.toFixed(4)}`;
                    timestampElement.textContent = `Updated: ${data.last_updated || 'Now'} (${data.source || 'API'})`;
                } else {
                    // Fallback rate
                    currentRateElement.textContent = '‚Çπ83.25';
                    timestampElement.textContent = 'Fallback rate - API unavailable';
                }
                
                // Update navbar timestamp
                const lastUpdateElement = document.getElementById('lastUpdate');
                if (lastUpdateElement) {
                    lastUpdateElement.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
                }
            } catch (error) {
                console.error('‚ùå Error loading current rates:', error);
                const currentRateElement = document.getElementById('currentRate');
                const timestampElement = document.getElementById('rateTimestamp');
                
                if (currentRateElement) currentRateElement.textContent = '‚Çπ83.25';
                if (timestampElement) timestampElement.textContent = 'Fallback rate - API unavailable';
            }
        }

        document.getElementById('plForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const resultsSection = document.getElementById('resultsSection');
            const results = document.getElementById('results');
            
            // Show loading
            resultsSection.style.display = 'block';
            results.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Calculating P&L using historical USD/INR data...</p>
                </div>
            `;
            
            // Collect form data
            const formData = {
                lc_id: document.getElementById('lcNumber').value,
                lc_amount: parseFloat(document.getElementById('lcAmount').value),
                lc_currency: 'USD',
                contract_rate: parseFloat(document.getElementById('contractRate').value),
                issue_date: document.getElementById('issueDate').value,
                maturity_date: document.getElementById('maturityDate').value,
                business_type: document.getElementById('businessType').value
            };
            
            console.log('üìä Sending P&L calculation request:', formData);
            
            try {
                const response = await fetch('/api/calculate-backdated-pl', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                console.log('‚úÖ P&L calculation result:', data);
                
                if (data.success && data.data) {
                    // Extract values from correct response structure
                    const plSummary = data.data.pl_summary;
                    const riskMetrics = data.data.risk_metrics;
                    const lcDetails = data.data.lc_details;
                    const dailyPL = data.data.daily_pl;
                    
                    // Display results with correct field names
                    const finalPL = plSummary.final_pl_inr;
                    const maxProfit = plSummary.max_profit_inr;
                    const maxLoss = plSummary.max_loss_inr;
                    const var95 = riskMetrics.var_95_inr;
                    const dataPoints = plSummary.total_data_points;
                    const dataSource = plSummary.data_source;
                    
                    const profitColor = finalPL >= 0 ? 'text-success' : 'text-danger';
                    const profitIcon = finalPL >= 0 ? 'üìà' : 'üìâ';
                    
                    results.innerHTML = `
                        <div class="alert alert-success">
                            <h6>${profitIcon} Backdated LC Analysis Complete</h6>
                            <p>Analysis based on real historical USD/INR exchange rates from ${lcDetails.issue_date} to ${lcDetails.maturity_date}</p>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card metric-card text-center">
                                    <div class="card-body">
                                        <h6>Final P&L</h6>
                                        <h4 class="${profitColor}">‚Çπ${finalPL.toLocaleString()}</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card metric-card text-center">
                                    <div class="card-body">
                                        <h6>Max Profit</h6>
                                        <h4 class="text-success">‚Çπ${maxProfit.toLocaleString()}</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card metric-card text-center">
                                    <div class="card-body">
                                        <h6>Max Loss</h6>
                                        <h4 class="text-danger">‚Çπ${maxLoss.toLocaleString()}</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card metric-card text-center">
                                    <div class="card-body">
                                        <h6>VaR (95%)</h6>
                                        <h4 class="text-warning">‚Çπ${var95.toLocaleString()}</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6>Analysis Details</h6>
                                        <p><strong>LC Number:</strong> ${lcDetails.lc_number}</p>
                                        <p><strong>Amount:</strong> $${lcDetails.amount_usd.toLocaleString()}</p>
                                        <p><strong>Contract Rate:</strong> ‚Çπ${lcDetails.contract_rate}</p>
                                        <p><strong>Data Points:</strong> ${dataPoints} days</p>
                                        <p><strong>Data Source:</strong> ${dataSource}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6>Risk Metrics</h6>
                                        <p><strong>P&L Volatility:</strong> ‚Çπ${riskMetrics.pl_volatility_inr.toLocaleString()}</p>
                                        <p><strong>Profit Days:</strong> ${riskMetrics.profit_days}/${dataPoints}</p>
                                        <p><strong>Loss Days:</strong> ${riskMetrics.loss_days}/${dataPoints}</p>
                                        <p><strong>Confidence Level:</strong> ${riskMetrics.confidence_level}%</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    resultsSection.style.display = 'block';
                } else {
                                        <h6>Analysis Details</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p><strong>LC Amount:</strong> $${formData.lc_amount.toLocaleString()}</p>
                                                <p><strong>Contract Rate:</strong> ‚Çπ${formData.contract_rate}</p>
                                                <p><strong>Business Type:</strong> ${formData.business_type.toUpperCase()}</p>
                                            </div>
                                            <div class="col-md-6">
                                                <p><strong>Data Points:</strong> ${data.daily_data_points} days</p>
                                                <p><strong>Data Source:</strong> ${data.data_source}</p>
                                                <p><strong>Analysis Type:</strong> Historical Backdated</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    
                    resultsSection.style.display = 'block';
                } else {
                    throw new Error(data.error || 'Calculation failed');
                }
                
            } catch (error) {
                console.error('‚ùå P&L calculation failed:', error);
                results.innerHTML = `
                    <div class="alert alert-danger">
                        <h6>‚ùå Calculation Failed</h6>
                        <p>Error: ${error.message}</p>
                        <p>Please check your inputs and try again.</p>
                    </div>
                `;
                resultsSection.style.display = 'block';
            }
        });
    </script>
</body>
</html>
